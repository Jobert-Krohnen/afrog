import{ae as Rt,af as Mt,Q as K,R as dt,j as o,W as a,ag as Ot,ah as ht}from"./CtJMHqX4.js";import{a as U}from"./BiS0q-Mq.js";const Oe=Mt,De=Rt,Dt="afrog.strategy.list",Tt="afrog.strategy.active",C={performance:{rateLimit:150,concurrency:25,smart:!1,timeout:50,retries:1,webFingerprint:!1,portScan:!1,ports:"",skipHostDiscovery:!1},http:{proxy:"",sort:"",headers:[],severity:[]},oob:{adapter:"",rateLimit:25,concurrency:25}};function nt(){return new Date().toISOString()}function I(){const t=globalThis.crypto?.randomUUID?.();if(t&&typeof t=="string")return t;const r=Date.now(),e=Math.random().toString(36).slice(2,8);return`${r}-${e}`}function _t(t){const r=new Ot;let e=!1;for(const s of t)(!s.id||r.has(s.id))&&(s.id=I(),e=!0),r.add(s.id);return{list:t,changed:e}}function qt(){try{const t=localStorage.getItem(Dt);if(!t)return[];const r=JSON.parse(t);return Array.isArray(r)?r:[]}catch{return[]}}function z(t){try{localStorage.setItem(Dt,JSON.stringify(t))}catch{return}}function Bt(){try{return localStorage.getItem(Tt)}catch{return null}}function yt(t){try{localStorage.setItem(Tt,t)}catch{return}}function $t(t){return JSON.parse(JSON.stringify(t))}function St(t){const r=C;return{performance:{...r.performance,...t.performance||{}},http:{...r.http,...t.http||{}},oob:{...r.oob,...t.oob||{}}}}function bt(t){const r={},e=t.performance,s={};e.smart!==C.performance.smart&&(s.smart=e.smart),e.timeout!==C.performance.timeout&&(s.timeout=e.timeout),e.retries!==C.performance.retries&&(s.retries=e.retries),e.webFingerprint!==C.performance.webFingerprint&&(s.webFingerprint=e.webFingerprint),e.portScan!==C.performance.portScan&&(s.portScan=e.portScan),e.skipHostDiscovery!==C.performance.skipHostDiscovery&&(s.skipHostDiscovery=e.skipHostDiscovery),((e.ports||"")+"").trim().length&&(s.ports=((e.ports||"")+"").trim()),e.smart||(e.rateLimit!==C.performance.rateLimit&&(s.rateLimit=e.rateLimit),e.concurrency!==C.performance.concurrency&&(s.concurrency=e.concurrency)),Object.keys(s).length&&(r.performance=s);const n=t.http,p={};(n.proxy||"")!==C.http.proxy&&(p.proxy=n.proxy||""),(n.sort||"")!==C.http.sort&&(p.sort=n.sort||"");const l=(n.headers||[]).filter(b=>b&&b.trim().length>0);l.length&&(p.headers=l);const T=(n.severity||[]).filter(b=>b&&b.trim().length>0);T.length&&(p.severity=T),Object.keys(p).length&&(r.http=p);const f=t.oob,g={};return(f.adapter||"")!==""&&(g.adapter=f.adapter||""),(g.adapter||"").trim().length>0&&(f.rateLimit!==C.oob.rateLimit&&(g.rateLimit=f.rateLimit),f.concurrency!==C.oob.concurrency&&(g.concurrency=f.concurrency)),Object.keys(g).length&&(r.oob=g),r}function at(t){const r=/\s/.test(t),e=/['"]/.test(t);return!r&&!e?t:`'${t.replace(/'/g,"'\\''")}'`}function vt(t){const r=St(t),e=bt(r),s=[];if(e.performance?.smart&&s.push("--smart"),typeof e.performance?.timeout=="number"&&s.push("--timeout",String(e.performance.timeout)),typeof e.performance?.retries=="number"&&s.push("--retries",String(e.performance.retries)),typeof e.performance?.rateLimit=="number"&&s.push("-rl",String(e.performance.rateLimit)),typeof e.performance?.concurrency=="number"&&s.push("-c",String(e.performance.concurrency)),e.performance?.webFingerprint&&s.push("-w"),e.performance?.portScan&&s.push("-ps"),e.performance?.ports&&e.performance.ports.trim().length&&s.push("-p",at(e.performance.ports.trim())),e.performance?.skipHostDiscovery&&s.push("-Pn"),e.http?.proxy&&e.http.proxy.trim().length&&s.push("--proxy",at(e.http.proxy.trim())),e.http?.sort&&e.http.sort.length&&s.push("--sort",e.http.sort),e.http?.severity&&e.http.severity.length&&s.push("-S",e.http.severity.join(",")),e.http?.headers&&e.http.headers.length)for(const n of e.http.headers)s.push("-H",at(n));return e.oob?.adapter&&e.oob.adapter.trim().length&&(s.push("--oob",at(e.oob.adapter.trim())),typeof e.oob.rateLimit=="number"&&s.push("-orl",String(e.oob.rateLimit)),typeof e.oob.concurrency=="number"&&s.push("-oc",String(e.oob.concurrency))),s}function Et(t){return["afrog",...vt(t)].join(" ")}function Ut(){const t=nt(),r={},e={id:I(),name:"默认策略",isDefault:!0,createdAt:t,updatedAt:t,payload:r},s={id:I(),name:"测试PoC策略",createdAt:t,updatedAt:t,payload:{performance:{rateLimit:50,concurrency:5,retries:2}}},n={id:I(),name:"高危扫描策略",createdAt:t,updatedAt:t,payload:{performance:{smart:!0}}};return[e,s,n]}let N=K(dt([])),W=K(null),Lt=!1;function Wt(){if(Lt)return;Lt=!0;const t=qt();a(N,Array.isArray(t)?t:[],!0);{const{list:e,changed:s}=_t(o(N));a(N,e,!0),s&&z(o(N))}if(o(N).length===0){a(N,Ut(),!0);const{list:e}=_t(o(N));a(N,e,!0),z(o(N))}const r=Bt();a(W,r&&o(N).some(e=>e.id===r)?r:o(N)[0]?.id||null,!0),o(W)&&yt(o(W))}function ot(){return o(N).find(t=>t.id===o(W))||null}function Pt(t){a(W,t,!0),yt(t)}function zt(t){const r=nt(),e={id:I(),name:t?.trim().length?t.trim():"新策略",createdAt:r,updatedAt:r,payload:{}};return a(N,[e,...o(N)],!0),Pt(e.id),z(o(N)),e.id}function Gt(t){a(N,o(N).filter(r=>r.id!==t),!0),o(W)===t&&(a(W,o(N)[0]?.id||null,!0),o(W)&&yt(o(W))),z(o(N))}function Qt(t,r){a(N,o(N).map(e=>e.id===t?{...e,name:r,updatedAt:nt()}:e),!0),z(o(N))}function Vt(t,r){const e=o(N).find(p=>p.id===t);if(!e)return null;const s=nt(),n={id:I(),name:r?.trim().length?r.trim():`${e.name} 副本`,isDefault:!1,createdAt:s,updatedAt:s,payload:$t(e.payload)};return a(N,[n,...o(N)],!0),z(o(N)),n.id}function Kt(t){a(N,o(N).map(r=>({...r,isDefault:r.id===t})),!0),z(o(N))}function Yt(t){const r=ot();if(!r)return;const e=bt(t),s={...r,payload:e,updatedAt:nt()};a(N,o(N).map(n=>n.id===r.id?s:n),!0),z(o(N))}function Xt(){const r=ot()?.payload||{};return St(r)}function Zt(){const t=ot();return vt(t?.payload||{})}function It(){const t=ot();return Et(t?.payload||{})}const At={get strategies(){return o(N)},get activeId(){return o(W)},load:Wt,setActive:Pt,create:zt,remove:Gt,rename:Qt,duplicate:Vt,setDefault:Kt,getActive:ot,getActiveMerged:Xt,saveActive:Yt,toActiveArgs:Zt,toActiveCommand:It,mergeWithBaseline:St,diffAgainstBaseline:bt,toArgs:vt,toCommandString:Et,BASELINE:C},kt="afrog_db",te=1,G="logs",Q="hits";let ct=null;async function st(){return ct||new Promise((t,r)=>{const e=indexedDB.open(kt,te);e.onerror=()=>r(e.error),e.onsuccess=()=>{ct=e.result,t(ct)},e.onupgradeneeded=s=>{const n=s.target.result;n.objectStoreNames.contains(G)||n.createObjectStore(G),n.objectStoreNames.contains(Q)||n.createObjectStore(Q)}})}async function ee(t,r){const e=await st();if(e)return new Promise((s,n)=>{const l=e.transaction(G,"readwrite").objectStore(G),T=JSON.parse(JSON.stringify(r||[])),f=l.put(T,t);f.onsuccess=()=>s(),f.onerror=()=>n(f.error)})}async function re(t){const r=await st();return r?new Promise(e=>{const p=r.transaction(G,"readonly").objectStore(G).get(t);p.onsuccess=()=>e(p.result||[]),p.onerror=()=>e([])}):[]}async function ne(t,r){const e=await st();if(e)return new Promise((s,n)=>{const l=e.transaction(Q,"readwrite").objectStore(Q),T=JSON.parse(JSON.stringify(r||[])),f=l.put(T,t);f.onsuccess=()=>s(),f.onerror=()=>n(f.error)})}async function oe(t){const r=await st();return r?new Promise(e=>{const p=r.transaction(Q,"readonly").objectStore(Q).get(t);p.onsuccess=()=>e(p.result||[]),p.onerror=()=>e([])}):[]}async function se(t){const r=await st();if(!r)return;const e=r.transaction([G,Q],"readwrite");e.objectStore(G).delete(t),e.objectStore(Q).delete(t)}const pt=t=>new Promise(r=>setTimeout(r,t)),Jt="afrog_scan_tasks",ut={};function jt(t){ut[t]&&clearTimeout(ut[t]),ut[t]=setTimeout(()=>{ee(t,o(J)[t]),ne(t,o(B)[t]),O(),delete ut[t]},2e3)}function O(){try{const t=JSON.stringify(o(i));localStorage.setItem(Jt,t)}catch(t){console.error("Failed to persist tasks",t)}}async function ie(){try{const t=localStorage.getItem(Jt);if(t){const r=JSON.parse(t);if(Array.isArray(r)){a(i,r.map(e=>({...e,status:e.status==="running"||e.status==="starting"?"failed":e.status})),!0);for(const e of o(i))try{const s=await re(e.id);Array.isArray(s)&&a(J,{...o(J),[e.id]:s},!0);const n=await oe(e.id);Array.isArray(n)&&a(B,{...o(B),[e.id]:n},!0)}catch(s){console.error("Failed to restore logs for task",e.id,s)}o(i).length>0&&!o(V)&&(a(V,o(i)[0].id,!0),a(it,!0))}}}catch(t){console.error("Failed to restore tasks",t)}try{const t=await U.listInstances(),r=new Ot;if(t?.success&&t.data?.instances)for(const s of t.data.instances)s.active_task_ids&&s.active_task_ids.forEach(n=>r.add(String(n)));let e=[...o(i)];for(const s of r){let n=e.find(p=>p.serverTaskId===s||p.id===s);if(n)n.status="running";else{const p=s;n={id:p,serverTaskId:s,name:`Remote Task ${s}`,status:"running",progress:{total:0,finished:0,hits:0,percent:0,rate:0,elapsedMs:0},severityStats:{critical:0,high:0,medium:0,low:0,info:0},createdAt:new ht().toISOString(),options:{...F},pocs:[]},e=[n,...e],a(J,{...o(J),[p]:[]},!0),a(B,{...o(B),[p]:[]},!0)}Ct(n.id,s)}a(i,e,!0),O()}catch(t){console.error("Failed to sync with backend",t)}}let it=K(!1),Ft=K(.33),i=K(dt([])),V=K(null);const lt={},x={},R={},gt={};let J=K(dt({})),B=K(dt({}));const F={concurrency:10,rate:100,timeout:1e4,followRedirects:!0,allowIntranet:!1,oob:!1};function ae(t){a(it,t,!0)}function ce(t){const r=Math.max(.3,Math.min(1,t));a(Ft,r,!0)}function ue(){return o(i).find(t=>t.id===o(V))||null}function pe(t,r){const e=String(Date.now()),s={id:e,name:t??"New Scan",status:"idle",progress:{total:0,finished:0,hits:0,percent:0,rate:0,elapsedMs:0},severityStats:{critical:0,high:0,medium:0,low:0,info:0},createdAt:new ht().toISOString(),options:{...F},pocs:[],targets:r||[]};return a(i,[s,...o(i)],!0),a(V,e,!0),a(it,!0),a(J,{...o(J),[e]:[]},!0),a(B,{...o(B),[e]:[]},!0),O(),e}function w(t){return t==null?"":String(t)}function wt(t){try{return JSON.stringify(t)}catch{return""}}function le(t){if(!t||typeof t!="object")return w(t);const r=t,e=w(r.target)||w(r.host)||w(r.ip)||w(r.addr)||w(r.address),s=w(r.port)||w(r.open_port),n=w(r.proto)||w(r.protocol),p=w(r.service)||w(r.name),l=w(r.state)||w(r.status),T=w(r.message);return[e&&s?`${e}:${s}`:e||s,n,p,l,T].filter(Boolean).join(" ")||wt(t)||"port"}function fe(t){if(!t||typeof t!="object")return w(t);const r=t,e=w(r.url)||w(r.target)||w(r.host)||w(r.ip),s=w(r.title),n=w(r.fingerprint)||w(r.product)||w(r.server),p=w(r.status)||w(r.code),l=w(r.message);return[e,p&&`(${p})`,n,s,l].filter(Boolean).join(" ")||wt(t)||"webprobe"}function de(t){if(!t||typeof t!="object")return w(t);const r=t;return w(r.host)||w(r.ip)||w(r.addr)||w(r.address)||w(r.target)||wt(t)||"host"}function k(t,r){H(t,{ts:Date.now(),type:"info",label:"PORT",text:le(r),data:r})}function tt(t,r){H(t,{ts:Date.now(),type:"info",label:"WEBPROBE",text:fe(r),data:r})}function mt(t,r){H(t,{ts:Date.now(),type:"info",label:"HOST",text:de(r),data:r})}function q(t,r){if(!(r.total_targets!==void 0||r.total_pocs!==void 0||r.total_scans!==void 0||r.targets!==void 0||r.oob_enabled!==void 0||r.oob_status!==void 0))return;const s=t.scanInfo||{total_targets:0,total_pocs:0,total_scans:0,targets:[],oob_enabled:!1,oob_status:""},n={...s,total_targets:typeof r.total_targets=="number"&&Number.isFinite(r.total_targets)?Number(r.total_targets):s.total_targets,total_pocs:typeof r.total_pocs=="number"&&Number.isFinite(r.total_pocs)?Number(r.total_pocs):s.total_pocs,total_scans:typeof r.total_scans=="number"&&Number.isFinite(r.total_scans)?Number(r.total_scans):s.total_scans,targets:Array.isArray(r.targets)?r.targets.map(p=>String(p||"")).filter(Boolean):s.targets,oob_enabled:typeof r.oob_enabled=="boolean"?r.oob_enabled:s.oob_enabled,oob_status:r.oob_status!==void 0?String(r.oob_status||""):s.oob_status};t.scanInfo=n}function ft(t,r){const e=String(r.phase||"").toLowerCase(),s=["host_discovery","portscan","webprobe","vuln","overall"].includes(e)?e:null;if(!s)return;const n=String(r.status||"").toLowerCase(),p=["running","completed","skipped","interrupted"].includes(n)?n:null;if(!p)return;const l=Number(r.finished),T=Number(r.total),f=Number(r.percent),g=Number(r.ts),b=t.phaseProgress||{},c={...b,[s]:{status:p,finished:Number.isFinite(l)?l:b[s]?.finished,total:Number.isFinite(T)?T:b[s]?.total,percent:Number.isFinite(f)?Math.max(0,Math.min(100,f)):b[s]?.percent,ts:Number.isFinite(g)?g:b[s]?.ts}};t.phaseProgress=c}function et(t,r){q(t,r);const e=Number(r.finished??t.progress.finished),s=Number(r.total??t.progress.total);t.progress.finished=Number.isFinite(e)?e:t.progress.finished,t.progress.total=Number.isFinite(s)?s:t.progress.total;const n=Number.isFinite(t.progress.finished)?t.progress.finished:0,p=Number.isFinite(t.progress.total)?t.progress.total:0,l=p>0?Math.floor((n||0)/Math.max(1,p||0)*100):0,T=Number(r.percent),f=r.percent!==void 0&&Number.isFinite(T)?Math.max(0,Math.min(100,T)):Math.max(0,Math.min(100,l));t.progress.percent=f;const g=Number(r.rate??t.progress.rate);Number.isFinite(g)&&(t.progress.rate=g);const b=Number(r.elapsedMs??t.progress.elapsedMs);Number.isFinite(b)&&(t.progress.elapsedMs=b)}function ge(t){const r=o(i).find(e=>e.id===t);r&&(r.status!=="running"&&r.status!=="starting"||(r.status="paused",a(i,o(i).map(e=>e.id===t?r:e),!0),O()))}function me(t){const r=o(i).find(e=>e.id===t);r&&r.status==="paused"&&(r.status="running",a(i,o(i).map(e=>e.id===t?r:e),!0),O())}function Ht(t){const r=o(i).find(p=>p.id===t);if(!r||r.status==="cancelled"||r.status==="completed"||r.status==="failed")return;r.status="cancelled",a(i,o(i).map(p=>p.id===t?r:p),!0),O();const e=lt[t];e&&(clearInterval(e),delete lt[t]);const s=x[t];if(s){try{s.abort()}catch{}delete x[t]}const n=R[t];if(n){try{n.close()}catch{}delete R[t]}try{U.stopScan(r.serverTaskId||t).catch(()=>{})}catch{}}function he(t){if(o(i).find(e=>e.id===t)){try{Ht(t)}catch{}delete o(J)[t],delete o(B)[t],se(t);try{const e=lt[t];e&&clearInterval(e),delete lt[t]}catch{}try{x[t]?.abort()}catch{}delete x[t];try{R[t]?.close()}catch{}delete R[t],a(i,o(i).filter(e=>e.id!==t),!0),o(V)===t&&a(V,o(i)[0]?.id||"",!0),O()}}function ye(t){a(V,t,!0)}async function xt(t,r,e=1e3,s){const n=o(i).find(p=>p.id===t);if(n&&!(n.status==="starting"||n.status==="running")&&!gt[t]){gt[t]=!0;try{const p=r[0]||"";n.target=p,n.targets=r.slice(),n.name=s||p||n.name,n.progress={total:e,finished:0,hits:n.progress.hits||0,percent:0,rate:0,elapsedMs:0},n.status="starting",n.startedAt=new ht().toISOString(),a(i,o(i).map(l=>l.id===t?n:l),!0),O(),a(J,{...o(J),[t]:o(J)[t]||[]},!0),a(V,t,!0),a(it,!0),n.poc&&H(t,{ts:Date.now(),type:"info",text:`使用 PoC ${n.poc.name}`}),n.options&&H(t,{ts:Date.now(),type:"debug",text:`并发 ${n.options.concurrency} · 速率 ${n.options.rate}/s · 超时 ${n.options.timeout}ms`});try{const l={targets:r.slice(),enable_stream:!0},T=(n.pocs||[]).map(g=>g.id);T.length?l.poc_ids=T:l.poc_source="default";try{const g=At.getActiveMerged(),b=At.diffAgainstBaseline(g),c=b?.performance||{},v=b?.http||{},L=b?.oob||{};c.smart&&(l.smart=!0),c.webFingerprint&&(l.web_fingerprint=!0),c.portScan&&(l.port_scan=!0),(c.ports||"").trim().length&&(l.ports=(c.ports||"").trim()),c.skipHostDiscovery&&(l.skip_host_discovery=!0),typeof c.timeout=="number"&&(l.timeout=c.timeout),typeof c.retries=="number"&&(l.retries=c.retries),typeof c.rateLimit=="number"&&(l.rate_limit=c.rateLimit),typeof c.concurrency=="number"&&(l.concurrency=c.concurrency),(v.proxy||"").trim().length&&(l.proxy=(v.proxy||"").trim()),v.sort&&v.sort.length&&(l.sort=v.sort),v.severity&&v.severity.length&&(l.severity=v.severity.join(",")),v.headers&&v.headers.length&&(l.headers=v.headers.slice()),(L.adapter||"").trim().length&&(l.enable_oob=!0,l.oob=(L.adapter||"").trim(),typeof L.rateLimit=="number"&&(l.oob_rate_limit=L.rateLimit),typeof L.concurrency=="number"&&(l.oob_concurrency=L.concurrency))}catch{}let f=s;if(!f){H(t,{ts:Date.now(),type:"info",text:"Loading..."});try{const g=await U.createScan(l),b=o(J)[t]||[];if(b.length>0&&b[b.length-1].text==="Loading..."&&a(J,{...o(J),[t]:b.slice(0,-1)},!0),g.success&&g.data){f=g.data.taskId;const c=g.data.scanInfo;c&&(n.scanInfo=c,H(t,{ts:Date.now(),type:"info",text:"Scan Started",data:c}))}else throw new Error(g.message||"Unknown error")}catch(g){const b=o(J)[t]||[];b.length>0&&b[b.length-1].text==="Loading..."&&a(J,{...o(J),[t]:b.slice(0,-1)},!0);const c=g instanceof Error?g.message:String(g||"");H(t,{ts:Date.now(),type:"error",text:`Failed to create scan: ${c}`}),n.status="failed",a(i,o(i).map(v=>v.id===t?n:v),!0),O();return}}n.serverTaskId=f;try{const g=await U.getServerInfo();n.serverBaseUrl=U.getBaseUrl(),n.serverInstanceId=String(g?.data?.instance_id||n.serverInstanceId||"")}catch{}for(a(i,o(i).map(g=>g.id===t?n:g),!0),O();;){const g=new AbortController;x[t]=g;let b;try{b=await U.openScanEvents(f,{signal:g.signal})}catch(h){console.error("Scan events probe failed",h);return}if(String(b.headers?.get("content-type")||"").toLowerCase().includes("text/event-stream")){g.abort(),delete x[t];const h=U.openScanEventsSSE(f);R[t]=h;const d=P=>{try{const S=JSON.parse(String(P.data||"{}"));et(n,S),a(i,o(i).map(j=>j.id===t?n:j),!0)}catch{}},A=P=>{try{const S=JSON.parse(String(P.data||"{}"));q(n,S),a(i,o(i).map(j=>j.id===t?n:j),!0)}catch{}},_=P=>{try{const S=JSON.parse(String(P.data||"{}"));ft(n,S),a(i,o(i).map(j=>j.id===t?n:j),!0)}catch{}},m=P=>{try{const S=JSON.parse(String(P.data||"{}")),j=String(S.status||"").toLowerCase();if(j){const X=n.status;if(n.status=["starting","running","paused","completed","failed","cancelled"].includes(j)?j:n.status,n.status==="completed"&&(n.progress.percent=100,n.progress.total>0&&(n.progress.finished=n.progress.total),H(t,{ts:Date.now(),type:"info",text:"Scan Completed",data:{severityStats:{...n.severityStats},total:n.progress.total,finished:n.progress.finished,duration:Date.now()-new Date(n.startedAt||n.createdAt).getTime()}})),a(i,o(i).map(Z=>Z.id===t?n:Z),!0),X!==n.status&&O(),j==="completed"||j==="failed"||j==="cancelled"){try{x[t]?.abort()}catch{}R[t]?.close(),delete R[t],delete x[t]}}}catch{}},u=P=>{try{const S=JSON.parse(String(P.data||"{}"));q(n,S);const j=String(S.type||"").toLowerCase();if(j==="port")return k(t,S);if(j==="webprobe")return tt(t,S);const X=String(S.severity||"info");n.severityStats[X]=(n.severityStats[X]||0)+1;const Z=(n.progress.hits||0)+1;H(t,{ts:Date.now(),type:"hit",text:String(S.message||"命中"),severity:X,pocName:String(S.poc?.name||n.poc?.name||""),url:String(S.target||n.target||""),label:"HTTP",seq:Z}),rt(t,{ts:Date.now(),severity:X,target:String(S.target||n.target||""),pocId:String(S.poc?.id||n.poc?.id||""),pocName:String(S.poc?.name||n.poc?.name||""),message:String(S.message||"命中"),seq:Z}),n.progress.hits=Z,a(i,o(i).map(Nt=>Nt.id===t?n:Nt),!0)}catch{}},M=P=>{try{const S=JSON.parse(String(P.data||"{}"));q(n,S),k(t,S)}catch{}},E=P=>{try{const S=JSON.parse(String(P.data||"{}"));q(n,S),tt(t,S)}catch{}},D=P=>{try{const S=JSON.parse(String(P.data||"{}"));q(n,S),mt(t,S)}catch{}};h.addEventListener("progress",d),h.addEventListener("scan_info",A),h.addEventListener("phase_progress",_),h.addEventListener("status",m),h.addEventListener("result",u),h.addEventListener("port",M),h.addEventListener("webprobe",E),h.addEventListener("host",D),h.onerror=()=>{try{R[t]?.close()}catch{}delete R[t],setTimeout(async()=>{["completed","failed","cancelled"].includes(n.status)||xt(t,n.targets||[],n.progress.total||1e3)},1500)};return}const v=b.body?.getReader();if(!v){await pt(1e3);continue}const L=new TextDecoder;let $="",Y=!1;const y=()=>{let h=0,d=0,A=-1;for(;h<$.length;){const _=$[h];if(_==="{")d===0&&(A=h),d++;else if(_==="}"&&(d--,d===0&&A>=0)){const m=$.slice(A,h+1).trim();try{const u=JSON.parse(m);q(n,u||{}),ft(n,u||{});const M=String(u?.type||"").toLowerCase();if(M==="port")k(t,u);else if(M==="webprobe")tt(t,u);else if(u&&(u.percent!==void 0||u.finished!==void 0||u.total!==void 0))et(n,u||{}),a(i,o(i).map(D=>D.id===t?n:D),!0);else if(u&&(u.severity!==void 0||u.poc!==void 0||u.target!==void 0)){const E=u||{},D=String(E.severity||"info");n.severityStats[D]=(n.severityStats[D]||0)+1;const P=(n.progress.hits||0)+1;H(t,{ts:Date.now(),type:"hit",text:String(E.message||"命中"),severity:D,pocName:String(E.poc?.name||n.poc?.name||""),url:String(E.target||n.target||""),label:"HTTP",seq:P}),rt(t,{ts:Date.now(),severity:D,target:String(E.target||n.target||""),pocId:String(E.poc?.id||n.poc?.id||""),pocName:String(E.poc?.name||n.poc?.name||""),message:String(E.message||"命中"),seq:P}),n.progress.hits=P,a(i,o(i).map(S=>S.id===t?n:S),!0)}else if(u&&u.status!==void 0){const D=String((u||{}).status||"").toLowerCase();if(D){const P=n.status;if(n.status=["starting","running","paused","completed","failed","cancelled"].includes(D)?D:n.status,n.status==="completed"&&(n.progress.percent=100,n.progress.total>0&&(n.progress.finished=n.progress.total)),a(i,o(i).map(S=>S.id===t?n:S),!0),P!==n.status&&O(),D==="completed"||D==="failed"||D==="cancelled"){try{x[t]?.abort()}catch{}delete x[t]}}}else if(u&&u.error!==void 0){const E=u||{};H(t,{ts:Date.now(),type:"error",text:String(E.message||"")}),n.status="failed",a(i,o(i).map(D=>D.id===t?n:D),!0),O()}}catch{}$=$.slice(h+1),h=-1,A=-1,d=0}h++}};for(;;){const{value:h,done:d}=await v.read();if(d){Y=!0;break}$+=L.decode(h,{stream:!0}),y()}if(["completed","failed","cancelled"].includes(n.status))break;if(Y){let h=null,d=null;try{const A=await U.getScanStatus(f);h=String(A?.data?.status||""),d=A?.data?.progress||null}catch{}if(d&&(et(n,d),a(i,o(i).map(A=>A.id===t?n:A),!0)),h==="completed"||h==="failed"||h==="cancelled"){n.status=h||n.status,n.status==="completed"&&(n.progress.percent=100,n.progress.total>0&&(n.progress.finished=n.progress.total)),a(i,o(i).map(A=>A.id===t?n:A),!0),O();break}await pt(1500);continue}break}}catch(l){const T=l instanceof Error?l.message:"";n.status="failed",a(i,o(i).map(f=>f.id===t?n:f),!0),O(),H(t,{ts:Date.now(),type:"error",text:T?`连接扫描事件失败: ${T}`:"连接扫描事件失败"})}}finally{gt[t]=!1}}}function Se(t,r){const e=o(i).find(n=>n.id===t);if(!e)return;const s={...e.options||F,...r};e.options=s,a(i,o(i).map(n=>n.id===t?e:n),!0),O()}function be(t,r){const e=o(i).find(s=>s.id===t);e&&(e.poc=r,a(i,o(i).map(s=>s.id===t?e:s),!0),O())}function ve(t,r){const e=o(i).find(n=>n.id===t);if(!e)return;const s=Array.isArray(e.pocs)?e.pocs.slice():[];s.find(n=>n.id===r.id)||s.push(r),e.pocs=s,a(i,o(i).map(n=>n.id===t?e:n),!0),O()}function we(t,r){const e=o(i).find(s=>s.id===t);e&&(e.pocs=(e.pocs||[]).filter(s=>s.id!==r),a(i,o(i).map(s=>s.id===t?e:s),!0),O())}function Ne(t){const r=o(i).find(e=>e.id===t);r&&(r.pocs=[],a(i,o(i).map(e=>e.id===t?r:e),!0),O())}function _e(t){F.concurrency=t.concurrency??F.concurrency,F.rate=t.rate??F.rate,F.timeout=t.timeout??F.timeout,F.followRedirects=t.followRedirects??F.followRedirects,F.allowIntranet=t.allowIntranet??F.allowIntranet,F.oob=t.oob??F.oob,a(i,o(i).map(r=>({...r,options:{...r.options||F,...t}})),!0),O()}function H(t,r){const e=(o(J)[t]||[]).slice();e.push(r),a(J,{...o(J),[t]:e.slice(-1e3)},!0),jt(t)}function rt(t,r){const e=(o(B)[t]||[]).slice();e.push(r),a(B,{...o(B),[t]:e.slice(-1e3)},!0),jt(t)}async function Ct(t,r){let e=o(i).find(s=>s.id===t);if(e)for(;;){const s=new AbortController;x[t]=s;let n;try{n=await U.openScanEvents(r,{signal:s.signal})}catch(c){console.error("Scan events probe failed",c);return}if(String(n.headers?.get("content-type")||"").toLowerCase().includes("text/event-stream")){s.abort(),delete x[t];const c=U.openScanEventsSSE(r);R[t]=c;const v=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));et(e,m),a(i,o(i).map(u=>u.id===t?e:u),!0)}catch{}},L=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));q(e,m),a(i,o(i).map(u=>u.id===t?e:u),!0)}catch{}},$=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));ft(e,m),a(i,o(i).map(u=>u.id===t?e:u),!0)}catch{}},Y=_=>{try{if(e=o(i).find(M=>M.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}")),u=String(m.status||"").toLowerCase();if(u){const M=e.status;if(e.status=["starting","running","paused","completed","failed","cancelled"].includes(u)?u:e.status,e.status==="completed"&&(e.progress.percent=100,e.progress.total>0&&(e.progress.finished=e.progress.total)),u==="paused"&&(e.status="paused"),a(i,o(i).map(E=>E.id===t?e:E),!0),M!==e.status&&O(),u==="completed"||u==="failed"||u==="cancelled"){try{x[t]?.abort()}catch{}R[t]?.close(),delete R[t],delete x[t]}}}catch{}},y=_=>{try{if(e=o(i).find(D=>D.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));q(e,m);const u=String(m.type||"").toLowerCase();if(u==="port")return k(t,m);if(u==="webprobe")return tt(t,m);const M=String(m.severity||"info");e.severityStats[M]=(e.severityStats[M]||0)+1;const E=(e.progress.hits||0)+1;H(t,{ts:Date.now(),type:"hit",text:String(m.message||"命中"),severity:M,pocName:String(m.poc?.name||e.poc?.name||""),url:String(m.target||e.target||""),label:"HTTP",seq:E}),rt(t,{ts:Date.now(),severity:M,target:String(m.target||e.target||""),pocId:String(m.poc?.id||e.poc?.id||""),pocName:String(m.poc?.name||e.poc?.name||""),message:String(m.message||"命中"),seq:E}),e.progress.hits=E,a(i,o(i).map(D=>D.id===t?e:D),!0)}catch{}},h=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));q(e,m),k(t,m)}catch{}},d=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));q(e,m),tt(t,m)}catch{}},A=_=>{try{if(e=o(i).find(u=>u.id===t)||e,!e)return;const m=JSON.parse(String(_.data||"{}"));q(e,m),mt(t,m)}catch{}};c.addEventListener("progress",v),c.addEventListener("scan_info",L),c.addEventListener("phase_progress",$),c.addEventListener("status",Y),c.addEventListener("result",y),c.addEventListener("port",h),c.addEventListener("webprobe",d),c.addEventListener("host",A),c.onerror=()=>{try{R[t]?.close()}catch{}delete R[t],setTimeout(async()=>{e=o(i).find(_=>_.id===t)||e,e&&!["completed","failed","cancelled"].includes(e.status)&&Ct(t,r)},1500)};return}const l=n.body?.getReader();if(!l){await pt(1e3);continue}const T=new TextDecoder;let f="",g=!1;const b=()=>{let c=0,v=0,L=-1;for(;c<f.length;){const $=f[c];if($==="{")v===0&&(L=c),v++;else if($==="}"&&(v--,v===0&&L>=0)){const Y=f.slice(L,c+1).trim();try{const y=JSON.parse(Y);if(q(e,y||{}),ft(e,y||{}),y&&(y.percent!==void 0||y.finished!==void 0||y.total!==void 0)){if(e=o(i).find(d=>d.id===t)||e,!e)return;et(e,y||{}),a(i,o(i).map(d=>d.id===t?e:d),!0)}else if(y&&y.host!==void 0&&y.port===void 0&&y.open_port===void 0&&y.url===void 0&&y.severity===void 0&&y.poc===void 0&&y.status===void 0&&y.phase===void 0)mt(t,y);else if(y&&(y.severity!==void 0||y.poc!==void 0||y.target!==void 0)){const h=String(y?.type||"").toLowerCase();if(h==="port"){k(t,y),f=f.slice(c+1),c=-1,L=-1,v=0;continue}if(h==="webprobe"){tt(t,y),f=f.slice(c+1),c=-1,L=-1,v=0;continue}if(e=o(i).find(m=>m.id===t)||e,!e)return;const d=y||{},A=String(d.severity||"info");e.severityStats[A]=(e.severityStats[A]||0)+1;const _=(e.progress.hits||0)+1;H(t,{ts:Date.now(),type:"hit",text:String(d.message||"命中"),severity:A,pocName:String(d.poc?.name||e.poc?.name||""),url:String(d.target||e.target||""),label:"HTTP",seq:_}),rt(t,{ts:Date.now(),severity:A,target:String(d.target||e.target||""),pocId:String(d.poc?.id||e.poc?.id||""),pocName:String(d.poc?.name||e.poc?.name||""),message:String(d.message||"命中"),seq:_}),e.progress.hits=_,a(i,o(i).map(m=>m.id===t?e:m),!0)}else if(y&&y.status!==void 0){if(e=o(i).find(A=>A.id===t)||e,!e)return;const d=String((y||{}).status||"").toLowerCase();if(d){const A=e.status;if(e.status=["starting","running","paused","completed","failed","cancelled"].includes(d)?d:e.status,e.status==="completed"&&(e.progress.percent=100,e.progress.total>0&&(e.progress.finished=e.progress.total)),a(i,o(i).map(_=>_.id===t?e:_),!0),A!==e.status&&O(),d==="completed"||d==="failed"||d==="cancelled"){try{x[t]?.abort()}catch{}delete x[t]}}}else if(y&&y.error!==void 0){if(e=o(i).find(d=>d.id===t)||e,!e)return;const h=y||{};H(t,{ts:Date.now(),type:"error",text:String(h.message||"")}),e.status="failed",a(i,o(i).map(d=>d.id===t?e:d),!0),O()}}catch{}f=f.slice(c+1),c=-1,L=-1,v=0}c++}};for(;;){const{value:c,done:v}=await l.read();if(v){g=!0;break}f+=T.decode(c,{stream:!0}),b()}if(["completed","failed","cancelled"].includes(e.status))break;if(g){let c=null,v=null;try{const L=await U.getScanStatus(r);c=String(L?.data?.status||""),v=L?.data?.progress||null}catch{}if(v&&(et(e,v),a(i,o(i).map(L=>L.id===t?e:L),!0)),c==="completed"||c==="failed"||c==="cancelled"){e.status=c||e.status,e.status==="completed"&&(e.progress.percent=100,e.progress.total>0&&(e.progress.finished=e.progress.total)),a(i,o(i).map(L=>L.id===t?e:L),!0),O();break}await pt(1500);continue}break}}const Te={get expanded(){return o(it)},get panelSnap(){return o(Ft)},get tasks(){return o(i)},get activeTask(){return ue()},get logs(){return o(J)},get hits(){return o(B)},get runningCount(){return o(i).filter(t=>t.status==="running"||t.status==="starting"||t.status==="paused").length},get defaultOptions(){return F},setPanelExpanded:ae,setPanelSnap:ce,createTask:pe,begin:xt,pause:ge,resume:me,cancel:Ht,removeTask:he,setActiveTask:ye,setTaskOptions:Se,setTaskPoc:be,addTaskPoc:ve,removeTaskPoc:we,clearTaskPocs:Ne,setGlobalOptions:_e,appendLog:H,appendHit:rt,restore:ie};export{De as P,Oe as R,At as a,Te as s};
